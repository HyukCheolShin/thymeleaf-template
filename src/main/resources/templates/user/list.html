<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>User List</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <script src="/js/jquery-3.7.1.min.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/common.js"></script>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>User List</h2>
            <div>
                <form action="/logout" method="post" style="display:inline;">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="btn btn-secondary me-2">Logout</button>
                </form>
                <a href="/users/form" class="btn btn-primary" sec:authorize="hasRole('ADMIN')">Add User</a>
            </div>
        </div>

        <!-- Search Form -->
        <div class="row mb-3">
            <div class="col-12 col-md-6">
                <form action="/users" method="get" class="input-group">
                    <select class="form-select" name="searchType" th:value="${searchType}" style="max-width: 150px;">
                        <option value="all" th:selected="${searchType == 'all'}">전체</option>
                        <option value="name" th:selected="${searchType == 'name'}">이름</option>
                        <option value="email" th:selected="${searchType == 'email'}">이메일</option>
                    </select>
                    <input type="text" class="form-control" name="keyword" th:value="${keyword}"
                        placeholder="검색어를 입력하세요">
                    <button class="btn btn-primary" type="submit">검색</button>
                </form>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th sec:authorize="hasRole('ADMIN')">Password</th>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Created At</th>
                        <th>Updated At</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="user : ${data.list}" th:onclick="'location.href=\'/users/form?id=' + ${user.id} + '\''"
                        style="cursor:pointer;">
                        <td th:text="${user.id}">1</td>
                        <td th:text="${user.email}">email@example.com</td>
                        <td sec:authorize="hasRole('ADMIN')" th:text="${user.password}">***</td>
                        <td th:text="${user.name}">Name</td>
                        <td th:text="${user.role}">USER</td>
                        <td th:text="${#dates.format(user.createdAt, 'yyyy-MM-dd HH:mm:ss')}">2024-01-01</td>
                        <td th:text="${#dates.format(user.updatedAt, 'yyyy-MM-dd HH:mm:ss')}">2024-01-01</td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(data.list)}">
                        <td colspan="7" class="text-center">데이터가 없습니다.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div th:if="${data.totalPages > 1}" class="mt-4 text-center">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    <!-- Previous -->
                    <li class="page-item" th:classappend="${data.currentPage == 1} ? 'disabled'">
                        <a class="page-link"
                            th:href="@{/users(page=${data.currentPage - 1}, keyword=${keyword}, searchType=${searchType})}"
                            th:onclick="'loadUsers(' + ${data.currentPage - 1} + '); return false;'">&laquo;</a>
                    </li>

                    <!-- Page Numbers -->
                    <li class="page-item" th:each="i : ${#numbers.sequence(
                            data.currentPage - 2 < 1 ? 1 : data.currentPage - 2, 
                            data.currentPage + 2 > data.totalPages ? data.totalPages : data.currentPage + 2)}"
                        th:classappend="${i == data.currentPage} ? 'active'">
                        <a class="page-link"
                            th:href="@{/users(page=${i}, keyword=${keyword}, searchType=${searchType})}"
                            th:onclick="'loadUsers(' + ${i} + '); return false;'" th:text="${i}">1</a>
                    </li>

                    <!-- Next -->
                    <li class="page-item" th:classappend="${data.currentPage == data.totalPages} ? 'disabled'">
                        <a class="page-link"
                            th:href="@{/users(page=${data.currentPage + 1}, keyword=${keyword}, searchType=${searchType})}"
                            th:onclick="'loadUsers(' + ${data.currentPage + 1} + '); return false;'">&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const isAdmin = /*[[${#authorization.expression('hasRole(''ADMIN'')')}]]*/ false;
        /*]]>*/
    </script>
    <script>
        $(() => {
            // 초기 로드 시 검색 폼의 submit 이벤트를 가로채서 API 호출로 변경
            $('form.input-group').on('submit', function (e) {
                e.preventDefault();
                loadUsers(1);
            });

            // 브라우저 뒤로가기/앞으로가기 이벤트 처리
            window.addEventListener('popstate', function (event) {
                const urlParams = new URLSearchParams(window.location.search);
                const page = urlParams.get('page') || 1;
                const keyword = urlParams.get('keyword') || '';
                const searchType = urlParams.get('searchType') || 'all';

                // 폼 값 동기화
                $('input[name="keyword"]').val(keyword);
                $('select[name="searchType"]').val(searchType);

                // 기록을 추가하지 않고 데이터만 로드
                loadUsers(page, false);
            });
        });

        function loadUsers(page, pushHistory = true) {
            const keyword = $('input[name="keyword"]').val();
            const searchType = $('select[name="searchType"]').val();

            $.ajax({
                url: '/api/users/',
                type: 'GET',
                data: {
                    page: page,
                    size: 10,
                    keyword: keyword,
                    searchType: searchType
                },
                success: function (response) {
                    if (response.code === 'SUCCESS') {
                        renderTable(response.data.list);
                        renderPagination(response.data, keyword, searchType);

                        // pushHistory가 true일 때만 URL 업데이트 (뒤로가기 시에는 false)
                        if (pushHistory) {
                            const newUrl = `/users?page=${page}&keyword=${keyword}&searchType=${searchType}`;
                            window.history.pushState({ path: newUrl }, '', newUrl);
                        }
                    } else {
                        alert('데이터를 불러오는데 실패했습니다.');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    alert('오류가 발생했습니다.');
                }
            });
        }

        function renderTable(list) {
            const tbody = $('tbody');
            tbody.empty();

            if (!list || list.length === 0) {
                tbody.append('<tr><td colspan="7" class="text-center">데이터가 없습니다.</td></tr>');
                return;
            }

            list.forEach(user => {
                let row = `<tr onclick="location.href='/users/form?id=${user.id}'" style="cursor:pointer;">
                    <td>${user.id}</td>
                    <td>${user.email}</td>`;

                if (isAdmin) {
                    row += `<td>${user.password}</td>`;
                }

                row += `<td>${user.name}</td>
                    <td>${user.role}</td>
                    <td>${formatDate(user.createdAt)}</td>
                    <td>${formatDate(user.updatedAt)}</td>
                </tr>`;
                tbody.append(row);
            });
        }

        function renderPagination(data, keyword, searchType) {
            const container = $('nav ul.pagination');
            container.empty();

            if (data.totalPages <= 1) return;

            // Previous
            const prevDisabled = data.currentPage === 1 ? 'disabled' : '';
            container.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="loadUsers(${data.currentPage - 1}); return false;">&laquo;</a>
                </li>
            `);

            // Page Numbers
            const startPage = Math.max(1, data.currentPage - 2);
            const endPage = Math.min(data.totalPages, data.currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const active = i === data.currentPage ? 'active' : '';
                container.append(`
                    <li class="page-item ${active}">
                        <a class="page-link" href="#" onclick="loadUsers(${i}); return false;">${i}</a>
                    </li>
                `);
            }

            // Next
            const nextDisabled = data.currentPage === data.totalPages ? 'disabled' : '';
            container.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="loadUsers(${data.currentPage + 1}); return false;">&raquo;</a>
                </li>
            `);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    </script>
</body>

</html>