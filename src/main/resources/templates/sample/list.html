<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Sample List</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/jquery-3.7.1.min.js"></script>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
    <h1>Sample List</h1>

    <!-- Sample Registration Form -->
    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9;">
        <h3 id="formTitle">Register New Sample</h3>
        <form id="saveForm">
            <input type="hidden" id="id">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <input type="text" id="name" placeholder="Name" required>
            <select id="role">
                <option value="USER">USER</option>
                <option value="ADMIN">ADMIN</option>
            </select>
            <button type="button" id="btnSave">Save</button>
            <button type="button" id="btnCancel" style="display:none;">Cancel</button>
        </form>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Password</th>
                <th>Name</th>
                <th>Role</th>
                <th>Created At</th>
                <th>Updated At</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="sampleTableBody">
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <div id="pagination" style="margin-top: 20px; text-align: center;">
    </div>

    <script>
        $(document).ready(function () {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            $.ajaxSetup({
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(header, token);
                }
            });

            var currentPage = 1;
            var pageSize = 10;

            loadSamples(currentPage);

            $('#btnSave').click(function () {
                var id = $('#id').val();
                var sampleData = {
                    email: $('#email').val(),
                    password: $('#password').val(),
                    name: $('#name').val(),
                    role: $('#role').val()
                };

                var url = '/api/samples/';
                var type = 'POST';

                if (id) {
                    url += id;
                    type = 'PUT';
                }

                $.ajax({
                    url: url,
                    type: type,
                    contentType: 'application/json',
                    data: JSON.stringify(sampleData),
                    success: function () {
                        alert('저장되었습니다.');
                        resetForm();
                        loadSamples(currentPage);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error saving sample:", error);
                        alert("저장 중 오류가 발생했습니다.");
                    }
                });
            });

            $('#btnCancel').click(function () {
                resetForm();
            });

            function resetForm() {
                $('#saveForm')[0].reset();
                $('#id').val('');
                $('#formTitle').text('Register New Sample');
                $('#btnSave').text('Save');
                $('#btnCancel').hide();
            }

            // Edit button click handler
            $(document).on('click', '.btn-edit', function () {
                var row = $(this).closest('tr');
                var sample = row.data('sample');

                $('#id').val(sample.id);
                $('#email').val(sample.email);
                $('#password').val(sample.password);
                $('#name').val(sample.name);
                $('#role').val(sample.role);

                $('#formTitle').text('Edit Sample (ID: ' + sample.id + ')');
                $('#btnSave').text('Update');
                $('#btnCancel').show();
            });

            // Delete button click handler
            $(document).on('click', '.btn-delete', function () {
                if (!confirm('정말 삭제하시겠습니까?')) return;

                var id = $(this).data('id');
                $.ajax({
                    url: '/api/samples/' + id,
                    type: 'DELETE',
                    success: function () {
                        alert('삭제되었습니다.');
                        loadSamples(currentPage);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error deleting sample:", error);
                        alert("삭제 중 오류가 발생했습니다.");
                    }
                });
            });

            // Pagination click handler
            $(document).on('click', '.page-link', function (e) {
                e.preventDefault();
                var page = $(this).data('page');
                if (page) {
                    currentPage = page;
                    loadSamples(page);
                }
            });

            function loadSamples(page) {
                $.ajax({
                    url: '/api/samples/',
                    type: 'GET',
                    data: {
                        page: page,
                        size: pageSize
                    },
                    dataType: 'json',
                    success: function (response) {
                        var data = response.list;
                        var totalPages = response.totalPages;
                        var currentPage = response.currentPage;

                        var tableBody = $('#sampleTableBody');
                        tableBody.empty();

                        $.each(data, function (index, sample) {
                            var row = $('<tr>');
                            row.data('sample', sample);

                            row.append($('<td>').text(sample.id));
                            row.append($('<td>').text(sample.email));
                            row.append($('<td>').text(sample.password));
                            row.append($('<td>').text(sample.name));
                            row.append($('<td>').text(sample.role));
                            row.append($('<td>').text(sample.created_at));
                            row.append($('<td>').text(sample.updated_at));

                            var actionTd = $('<td>');
                            var editBtn = $('<button>').text('Edit').addClass('btn-edit').css('margin-right', '5px');
                            var deleteBtn = $('<button>').text('Delete').addClass('btn-delete').data('id', sample.id);
                            actionTd.append(editBtn).append(deleteBtn);
                            row.append(actionTd);

                            tableBody.append(row);
                        });

                        renderPagination(totalPages, currentPage);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching samples:", error);
                        alert("데이터를 불러오는 중 오류가 발생했습니다.");
                    }
                });
            }

            function renderPagination(totalPages, currentPage) {
                var paginationDiv = $('#pagination');
                paginationDiv.empty();

                if (totalPages <= 1) return;

                // Previous Button
                if (currentPage > 1) {
                    paginationDiv.append('<a href="#" class="page-link" data-page="' + (currentPage - 1) + '" style="margin: 0 5px;">&laquo; Prev</a>');
                }

                // Page Numbers
                var startPage = Math.max(1, currentPage - 2);
                var endPage = Math.min(totalPages, currentPage + 2);

                for (var i = startPage; i <= endPage; i++) {
                    var link = $('<a href="#" class="page-link" data-page="' + i + '" style="margin: 0 5px;">' + i + '</a>');
                    if (i === currentPage) {
                        link.css('font-weight', 'bold');
                        link.css('text-decoration', 'underline');
                    }
                    paginationDiv.append(link);
                }

                // Next Button
                if (currentPage < totalPages) {
                    paginationDiv.append('<a href="#" class="page-link" data-page="' + (currentPage + 1) + '" style="margin: 0 5px;">Next &raquo;</a>');
                }
            }
        });
    </script>
</body>

</html>