<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <title>Sample List</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/jquery-3.7.1.min.js"></script>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
    <h1>Sample List</h1>

    <!-- Sample Registration Form -->
    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9;">
        <h3>Register New Sample</h3>
        <form id="saveForm">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <input type="text" id="name" placeholder="Name" required>
            <select id="role">
                <option value="USER">USER</option>
                <option value="ADMIN">ADMIN</option>
            </select>
            <button type="button" id="btnSave">Save</button>
        </form>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Password</th>
                <th>Name</th>
                <th>Role</th>
                <th>Created At</th>
                <th>Updated At</th>
            </tr>
        </thead>
        <tbody id="sampleTableBody">
        </tbody>
    </table>

    <script>
        $(document).ready(function () {
            var token = $("meta[name='_csrf']").attr("content");
            var header = $("meta[name='_csrf_header']").attr("content");

            $.ajaxSetup({
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(header, token);
                }
            });

            loadSamples();

            $('#btnSave').click(function () {
                var sampleData = {
                    email: $('#email').val(),
                    password: $('#password').val(),
                    name: $('#name').val(),
                    role: $('#role').val()
                };

                $.ajax({
                    url: '/api/samples/',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(sampleData),
                    success: function () {
                        alert('저장되었습니다.');
                        loadSamples(); // Reload list
                        $('#saveForm')[0].reset(); // Clear form
                    },
                    error: function (xhr, status, error) {
                        console.error("Error saving sample:", error);
                        alert("저장 중 오류가 발생했습니다.");
                    }
                });
            });

            function loadSamples() {
                $.ajax({
                    url: '/api/samples/',
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        var tableBody = $('#sampleTableBody');
                        tableBody.empty();

                        $.each(data, function (index, sample) {
                            var row = $('<tr>');
                            row.append($('<td>').text(sample.id));
                            row.append($('<td>').text(sample.email));
                            row.append($('<td>').text(sample.password));
                            row.append($('<td>').text(sample.name));
                            row.append($('<td>').text(sample.role));
                            row.append($('<td>').text(sample.created_at));
                            row.append($('<td>').text(sample.updated_at));
                            tableBody.append(row);
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching samples:", error);
                        alert("데이터를 불러오는 중 오류가 발생했습니다.");
                    }
                });
            }
        });
    </script>
</body>

</html>